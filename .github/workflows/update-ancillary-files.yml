name: Update the ancillary files
on:
  push:
    branches:
      - master
    paths:
      - gradle/libs.versions.toml
  workflow_dispatch:

jobs:
  update-ancillary-files:
    runs-on: ubuntu-24.04
    concurrency:
      group: javadoc-io-${{ github.workflow }}-${{ github.event.number || github.ref }}
    steps:
      - name: Checkout
        uses: danysk/action-checkout@7f6ee3cd5bd670cdb3e162894776736254afff1e # 0.2.27
        with:
          token: ${{ secrets.DEPLOYMENT_TOKEN }}
      - uses: DanySK/build-check-deploy-gradle-action@810719541546fff1db1edd1fb858e12654dc1d95 # 4.0.17
        with:
          pre-build-command: rm -rf dokka-cache
          build-command: |
            for i in {1..3}; do
                rm dokka-cache/no-javadoc.json || true
                ./gradlew dokkaGenerateModuleHtml dokkaGeneratePublicationHtml --dry-run
            done
            ./gradlew kotlinUpgradeYarnLock kotlinWasmUpgradeYarnLock
          check-command: |
            git config user.name 'Danilo Pianini [bot]'
            git config user.email 'danilo.pianini@gmail.com'
            git add dokka-cache || true
            git commit -nm 'chore(build): update the javadoc.io cache' || true
            git pull --rebase --autostash
            git push
            git add kotlin-js-store || true
            git commit -nm 'chore(build): actualize the Kotlin JS store' || true
            git pull --rebase --autostash
            git push
          should-run-codecov: false
          should-deploy: false
